<?php

/**
 * ุณูุฑูุจุช ุงูุชุซุจูุช ุงูุชููุงุฆู ููุดุฑูุน DIPS Academy
 * 
 * ูููู ูุฐุง ุงูุณูุฑูุจุช ุจุชุซุจูุช ุงููุดุฑูุน ุชููุงุฆูุงู ูุน ุฌููุน ุงูุชุจุนูุงุช
 */

echo "\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "โ                                                           โ\n";
echo "โ        ๐ DIPS Academy - ุณูุฑูุจุช ุงูุชุซุจูุช ุงูุชููุงุฆู        โ\n";
echo "โ                                                           โ\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "\n";

// ุงูุชุญูู ูู PHP
echo "๐ ุงูุชุญูู ูู ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ...\n\n";

$phpVersion = phpversion();
echo "โ PHP Version: {$phpVersion}\n";

if (version_compare($phpVersion, '8.2.0', '<')) {
    echo "โ ุฎุทุฃ: ูุชุทูุจ PHP 8.2 ุฃู ุฃุญุฏุซ. ุงููุณุฎุฉ ุงูุญุงููุฉ: {$phpVersion}\n";
    exit(1);
}

// ุงูุชุญูู ูู Composer
exec('composer -V', $output, $return);
if ($return !== 0) {
    echo "โ ุฎุทุฃ: Composer ุบูุฑ ูุซุจุช\n";
    echo "๐ฅ ูุฑุฌู ุชุซุจูุช Composer ูู: https://getcomposer.org/\n";
    exit(1);
}
echo "โ Composer: ูุซุจุช\n";

// ุงูุชุญูู ูู Node
exec('node -v', $output, $return);
if ($return !== 0) {
    echo "โ ุฎุทุฃ: Node.js ุบูุฑ ูุซุจุช\n";
    echo "๐ฅ ูุฑุฌู ุชุซุจูุช Node.js ูู: https://nodejs.org/\n";
    exit(1);
}
echo "โ Node.js: ูุซุจุช\n";

echo "\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "\n";

// ุจุฏุก ุงูุชุซุจูุช
echo "๐ ุจุฏุก ุนูููุฉ ุงูุชุซุจูุช...\n\n";

// ุงูุฎุทูุฉ 1: ุชุซุจูุช ุชุจุนูุงุช Composer
echo "๐ฆ [1/9] ุชุซุจูุช ุชุจุนูุงุช PHP (Composer)...\n";
passthru('composer install', $return);
if ($return !== 0) {
    echo "โ ูุดู ุชุซุจูุช ุชุจุนูุงุช Composer\n";
    exit(1);
}
echo "โ ุชู ุชุซุจูุช ุชุจุนูุงุช PHP ุจูุฌุงุญ\n\n";

// ุงูุฎุทูุฉ 2: ุชุซุจูุช ุชุจุนูุงุช NPM
echo "๐ฆ [2/9] ุชุซุจูุช ุชุจุนูุงุช JavaScript (NPM)...\n";
passthru('npm install', $return);
if ($return !== 0) {
    echo "โ๏ธ  ุชุญุฐูุฑ: ูุฏ ุชููู ููุงู ูุดููุฉ ูู ุชุซุจูุช NPM\n";
}
echo "โ ุชู ุชุซุจูุช ุชุจุนูุงุช JavaScript\n\n";

// ุงูุฎุทูุฉ 3: ูุณุฎ ููู .env
echo "โ๏ธ  [3/9] ุฅุนุฏุงุฏ ููู ุงูุจูุฆุฉ (.env)...\n";
if (!file_exists('.env')) {
    if (file_exists('.env.example')) {
        copy('.env.example', '.env');
        echo "โ ุชู ูุณุฎ .env.example ุฅูู .env\n\n";
    } else {
        echo "โ ุฎุทุฃ: ููู .env.example ุบูุฑ ููุฌูุฏ\n";
        exit(1);
    }
} else {
    echo "โน๏ธ  ููู .env ููุฌูุฏ ุจุงููุนู\n\n";
}

// ุงูุฎุทูุฉ 4: ุชูููุฏ ููุชุงุญ ุงูุชุทุจูู
echo "๐ [4/9] ุชูููุฏ ููุชุงุญ ุงูุชุทุจูู...\n";
passthru('php artisan key:generate', $return);
if ($return !== 0) {
    echo "โ ูุดู ุชูููุฏ ููุชุงุญ ุงูุชุทุจูู\n";
    exit(1);
}
echo "โ ุชู ุชูููุฏ ููุชุงุญ ุงูุชุทุจูู\n\n";

// ุงูุฎุทูุฉ 5: ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช
echo "๐๏ธ  [5/9] ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช...\n";
echo "โน๏ธ  ูุฑุฌู ุงูุชุฃูุฏ ูู ุชุดุบูู MySQL\n";

// ูุฑุงุกุฉ ุฅุนุฏุงุฏุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู .env
$env = file_get_contents('.env');
preg_match('/DB_DATABASE=(.*)/', $env, $matches);
$dbName = $matches[1] ?? 'dips_academy';

echo "๐ ุงุณู ูุงุนุฏุฉ ุงูุจูุงูุงุช: {$dbName}\n";

// ูุญุงููุฉ ุฅูุดุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช
try {
    $pdo = new PDO("mysql:host=127.0.0.1", "root", "");
    $pdo->exec("CREATE DATABASE IF NOT EXISTS `{$dbName}` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
    echo "โ ุชู ุฅูุดุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช: {$dbName}\n\n";
} catch (PDOException $e) {
    echo "โ๏ธ  ุชุญุฐูุฑ: ูู ูุชู ุฅูุดุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชููุงุฆูุงู\n";
    echo "โน๏ธ  ูุฑุฌู ุฅูุดุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฏููุงู: {$dbName}\n\n";
}

// ุงูุฎุทูุฉ 6: ุชุดุบูู Migrations
echo "๐ [6/9] ุชุดุบูู Migrations...\n";
passthru('php artisan migrate --seed', $return);
if ($return !== 0) {
    echo "โ ูุดู ุชุดุบูู Migrations\n";
    echo "โน๏ธ  ูุฑุฌู ุงูุชุฃูุฏ ูู ุฅุนุฏุงุฏุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู .env\n";
    exit(1);
}
echo "โ ุชู ุชุดุบูู Migrations ุจูุฌุงุญ\n\n";

// ุงูุฎุทูุฉ 7: ูุดุฑ ูููุงุช Filament
echo "๐ [7/9] ูุดุฑ ูููุงุช Filament...\n";
passthru('php artisan filament:install --panels', $return);
echo "โ ุชู ูุดุฑ ูููุงุช Filament\n\n";

// ุงูุฎุทูุฉ 8: ุฑุจุท ุงูุชุฎุฒูู
echo "๐ [8/9] ุฑุจุท ูุฌูุฏ ุงูุชุฎุฒูู...\n";
passthru('php artisan storage:link', $return);
echo "โ ุชู ุฑุจุท ูุฌูุฏ ุงูุชุฎุฒูู\n\n";

// ุงูุฎุทูุฉ 9: ุจูุงุก Assets
echo "๐จ [9/9] ุจูุงุก Assets...\n";
passthru('npm run build', $return);
if ($return !== 0) {
    echo "โ๏ธ  ุชุญุฐูุฑ: ูุฏ ุชููู ููุงู ูุดููุฉ ูู ุจูุงุก Assets\n";
} else {
    echo "โ ุชู ุจูุงุก Assets ุจูุฌุงุญ\n\n";
}

// ุงูุงูุชูุงุก
echo "\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "โ                                                           โ\n";
echo "โ          ๐ ุชู ุชุซุจูุช ุงููุดุฑูุน ุจูุฌุงุญ! ๐                   โ\n";
echo "โ                                                           โ\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "\n";

// ูุนูููุงุช ุงููุตูู
echo "๐ ูุนูููุงุช ูุงูุฉ:\n\n";
echo "๐ ุงููููุน: http://dips-academy.test\n";
echo "   (ุฃู http://localhost:8000 ุฅุฐุง ููุช ุชุณุชุฎุฏู php artisan serve)\n\n";
echo "๐ ููุญุฉ ุงูุชุญูู: http://dips-academy.test/admin\n\n";
echo "๐ค ุจูุงูุงุช ุงูุฏุฎูู:\n";
echo "   Super Admin:\n";
echo "   - ุงูุจุฑูุฏ: superadmin@dips-academy.com\n";
echo "   - ูููุฉ ุงููุฑูุฑ: password\n\n";
echo "   Admin:\n";
echo "   - ุงูุจุฑูุฏ: admin@dips-academy.com\n";
echo "   - ูููุฉ ุงููุฑูุฑ: password\n\n";
echo "   Instructor:\n";
echo "   - ุงูุจุฑูุฏ: instructor1@dips-academy.com\n";
echo "   - ูููุฉ ุงููุฑูุฑ: password\n\n";

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "\n";
echo "๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:\n\n";
echo "1. ุงูุฑุฃ ุงูุชูุซูู:\n";
echo "   - README.md\n";
echo "   - INSTALLATION.md\n";
echo "   - MULTI_TENANT_GUIDE.md\n\n";
echo "2. ุฌุฑุจ ูุธุงู Multi-Tenant:\n";
echo "   php artisan tenant:create 1\n\n";
echo "3. ุงุจุฏุฃ ุงูุชุทููุฑ:\n";
echo "   - ุณุฌู ุฏุฎูู ุฅูู ููุญุฉ ุงูุชุญูู\n";
echo "   - ุฃุถู ุฏูุฑุงุช ุฌุฏูุฏุฉ\n";
echo "   - ุงุณุชูุดู ุงูููุฒุงุช\n\n";

echo "๐ ุดูุฑุงู ูุงุณุชุฎุฏุงู DIPS Academy!\n";
echo "๐ ุตููุน ุจุญุจ ุจูุงุณุทุฉ OMAR HAJJOUB\n\n";

// ุณุคุงู ุนู ุชุดุบูู ุงูุฎุงุฏู
echo "โ ูู ุชุฑูุฏ ุชุดุบูู ุฎุงุฏู ุงูุชุทููุฑ ุงูุขูุ (y/n): ";
$handle = fopen("php://stdin", "r");
$line = trim(fgets($handle));
fclose($handle);

if (strtolower($line) === 'y' || strtolower($line) === 'yes') {
    echo "\n๐ ุฌุงุฑู ุชุดุบูู ุฎุงุฏู ุงูุชุทููุฑ...\n";
    echo "๐ ุงููููุน: http://localhost:8000\n";
    echo "โน๏ธ  ุงุถุบุท Ctrl+C ูุฅููุงู ุงูุฎุงุฏู\n\n";
    passthru('php artisan serve');
} else {
    echo "\nโ ููููู ุชุดุบูู ุงูุฎุงุฏู ูุงุญูุงู ุจุงุณุชุฎุฏุงู: php artisan serve\n\n";
}
